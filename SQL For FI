SQL code needed:

use [TrilliumDataWarehouse]

set nocount on;

IF OBJECT_ID('tempdb.dbo.#DAD', 'U') IS NOT NULL
       DROP TABLE #DAD;

SELECT [AbstractID]
      ,[IsCVHData]
      ,[SiteCode]
      ,[SiteDescription]
      ,[PatientIdentifier]
      ,[EncounterNumber]
      ,[InstitutionCode]
      ,[InstitutionDescription]
      ,[ChartNumber]
      ,[HealthCareNumber]
      ,[IsValidHealthCareNumber]
      ,[HCNProvinceCode]
      ,[HCNProvinceDescription]
      ,[ResponsibilityForPaymentCode]
      ,[ResponsibilityForPaymentDescription]
      ,[RegisterNumber]
      ,[BirthDate]
      ,[AgeNumber]
      ,[AgeCode]
      ,[DischargeAge]
      ,[DischargeAgeCode]
      ,[GenderCode]
      ,[GenderDescription]
      ,[PostalCode]
      ,[ResidenceCode]
      ,[ResidenceCodeDescription]
      ,[AdmitDate]
      ,[DischargeDate]
      ,[DateLeftER]
      ,[DeliveryDate]
      ,[WaitTimeER]
      ,[EntryCode]
      ,[EntryCodeDescription]
      ,[AdmitCategoryCode]
      ,[AdmitCategoryDescription]
      ,[ReadmitCode]
      ,[ReadmitDescription]
      ,[DischargeDispositionCode]
      ,[DischargeDispositionDescription]
      ,[CMG_Year]
      ,[MCC]
      ,[MCCDescription]
      ,[CMG]
      ,[CMGDescription]
      ,[CMG_RIW]
      ,[CMG_ELOS]
      ,[InpatientRIWAtypicalCode]
      ,[InpatientRIWAtypicalCodeDescription]
      ,[ComorbidityLevel]
      ,[ComorbidityLevelDescription]
      ,[CMGAgeCategory]
      ,[CMGAgeCategoryDescription]
      ,[InterventionEventCount]
      ,[InterventionEventCountDescription]
      ,[FlaggedIntervFactorCount]
      ,[FlaggedInterventionEventCountDescription]
      ,[InterventionOOHCount]
      ,[InterventionOOHCountDescription]
      ,[InpatientRILevel]
      ,[HIGCode]
      ,[HIGDescription]
      ,[HIGWeight]
      ,[HIGELOS]
      ,[HIGFlTotalCount]
      ,[LOSDays]
      ,[AcuteLOS]
      ,[ALCLOS]
      ,[SCULOS]
      ,[SCUHours]
      ,[DischargeUnitKey]
      ,[DischargeNursingUnitCode]
      ,[DischargeNursingUnitDescription]
      ,[InstitutionFromCode]
      ,[InstitutionFromDescription]
      ,[InstitutionFromCareType]
      ,[InstitutionFromHospitalType]
      ,[InstitutionToCode]
      ,[InstitutionToDescription]
      ,[InstitutionToCareType]
      ,[InstitutionToHospitalType]
      ,[DiagnosisType]
      ,[DiagnosisTypeDescription]
      ,[DiagnosisCode]
      ,[DiagnosisCIHICode]
      ,[DiagnosisDescription]
      ,[DiagnosisCategoryCode]
      ,[DiagnosisCategoryDescription]
      ,[InterventionCode]
      ,[InterventionCIHICode]
      ,[InterventionDescription]
      ,[InterventionCategoryCode]
      ,[InterventionCategoryDescription]
      ,[ProviderServiceCode]
      ,[ProviderServiceDescription]
      ,[ProviderTypeCode]
      ,[ProviderTypeDescription]
      ,[ProviderCode]
      ,[ProviderName]
      ,[ProviderCodeMeditech]
      ,[PatientServiceCode]
      ,[PatientServiceDescription]
      ,[FI_CardioversionFlag]
      ,[FI_CellSaverFlag]
      ,[FI_ChemotherapyFlag]
      ,[FI_DialysisFlag]
      ,[FI_HeartResuscitationFlag]
      ,[FI_MechanicalVentGreat96Hours]
      ,[FI_MechanicalVentLess96Hours]
      ,[FI_FeedingTubeFlag]
      ,[FI_ParacentesisFlag]
      ,[FI_ParenteralNutritionFlag]
      ,[FI_PleurocentesisFlag]
      ,[FI_RadiotherapyFlag]
      ,[FI_TracheostomyFlag]
      ,[FI_VascularAccessDdeviceFlag]
      ,[DxIntervPartition]
      ,[DxIntervPartitionDesc]
      ,[AgeGroupKey]
      ,[FSA]
      ,[LHIN]
      ,[AgeDays]
      ,[AgeMonths]
      ,[AgeYears]
      ,[ResidenceRegion]
      ,[IntervLocation]
      ,[IntervLocationDesc]
      ,[InterventionProviderNumber]
      ,[InterventionProviderNumberDesc]
      ,[InterventionProviderService]
      ,[IntervProviderServiceDesc]
      ,[CodedAgeGroup]
      ,[GestationalAgeinweeks]
      ,[LOSTimeinHours]
      ,[OffService]
      ,[IntervBodyLocation]
      ,[IntervBodyLocationDesc]
      ,[SCUNumber]
      ,[InterventionAttributeStatus]
      ,[InterventionAttributeStatusDescription]
      ,[AnaestheticTechniqueCode]
      ,[AnaestheticTechniqueDescription]
      ,[HIGTypicalAtypicalCode]
      ,[HIGTypicalAtypicalDescription]
      ,[InternalProgramMapping]
  into #DAD
  FROM [TrilliumDataWarehouse].[dbo].[FactInpatientTemp]
  
create index idx_DAD on #DAD([AbstractID],[CMG_Year])  


IF OBJECT_ID('tempdb.dbo.#allDiag', 'U') IS NOT NULL
       DROP TABLE #allDiag;


IF OBJECT_ID('tempdb.dbo.#allInter', 'U') IS NOT NULL
       DROP TABLE #allInter;


-- Create Diagnosis list
select [AbstractID],[SiteCode],[EncounterNumber],[ChartNumber],[AdmitDate],[DischargeDate],[Diagnosis1],[Diagnosis2],[Diagnosis3],[Diagnosis4],[Diagnosis5],[Diagnosis6],[Diagnosis7],[Diagnosis8],[Diagnosis9],[Diagnosis10],[Diagnosis11],[Diagnosis12],[Diagnosis13],[Diagnosis14],[Diagnosis15],[Diagnosis16],[Diagnosis17],[Diagnosis18],[Diagnosis19],[Diagnosis20],[Diagnosis21],[Diagnosis22],[Diagnosis23],[Diagnosis24],[Diagnosis25],[Diagnosis26],[Diagnosis27],[Diagnosis28],[Diagnosis29],[Diagnosis30],[Diagnosis31],[Diagnosis32],[Diagnosis33],[Diagnosis34],[Diagnosis35],[Diagnosis36],[Diagnosis37],[Diagnosis38],[Diagnosis39],[Diagnosis40],[Diagnosis41],[Diagnosis42],[Diagnosis43],[Diagnosis44],[Diagnosis45],[Diagnosis46],[Diagnosis47],[Diagnosis48],[Diagnosis49],[Diagnosis50],[Diagnosis51],[Diagnosis52],[Diagnosis53],[Diagnosis54],[Diagnosis55],[Diagnosis56],[Diagnosis57],[Diagnosis58],[Diagnosis59],[Diagnosis60],[Diagnosis61],[Diagnosis62],[Diagnosis63],[Diagnosis64],[Diagnosis65]
into #allDiag
from (
       SELECT FIT.[AbstractID],[SiteCode],[EncounterNumber],[ChartNumber],[AdmitDate],[DischargeDate]
                ,'Diagnosis'+LTRIM(STR([DiagnosisInstance],4)) as [DiagnosisTitle]
                ,DD.[DiagnosisCode]
         FROM [TrilliumDataWarehouse].[dbo].[FactInpatientTemp] FIT
         inner join [TrilliumDataWarehouse].[dbo].[FactInpatientDiagnosisTemp] FIDT
         inner join [TrilliumDataWarehouse].[dbo].[DimDiagnosis] DD on DD.[DiagnosisKey]=FIDT.[DiagnosisKey]
         on FIDT.[AbstractID]=FIT.[AbstractID]
) as base
PIVOT
(
       max([DiagnosisCode])
       for [DiagnosisTitle] in ([Diagnosis1],[Diagnosis2],[Diagnosis3],[Diagnosis4],[Diagnosis5],[Diagnosis6],[Diagnosis7],[Diagnosis8],[Diagnosis9],[Diagnosis10],[Diagnosis11],[Diagnosis12],[Diagnosis13],[Diagnosis14],[Diagnosis15],[Diagnosis16],[Diagnosis17],[Diagnosis18],[Diagnosis19],[Diagnosis20],[Diagnosis21],[Diagnosis22],[Diagnosis23],[Diagnosis24],[Diagnosis25],[Diagnosis26],[Diagnosis27],[Diagnosis28],[Diagnosis29],[Diagnosis30],[Diagnosis31],[Diagnosis32],[Diagnosis33],[Diagnosis34],[Diagnosis35],[Diagnosis36],[Diagnosis37],[Diagnosis38],[Diagnosis39],[Diagnosis40],[Diagnosis41],[Diagnosis42],[Diagnosis43],[Diagnosis44],[Diagnosis45],[Diagnosis46],[Diagnosis47],[Diagnosis48],[Diagnosis49],[Diagnosis50],[Diagnosis51],[Diagnosis52],[Diagnosis53],[Diagnosis54],[Diagnosis55],[Diagnosis56],[Diagnosis57],[Diagnosis58],[Diagnosis59],[Diagnosis60],[Diagnosis61],[Diagnosis62],[Diagnosis63],[Diagnosis64],[Diagnosis65])
) as pvt


create index idx_allDiag on #allDiag([AbstractID])


-- Create Intervention list
select [AbstractID],[Intervention1],[Intervention2],[Intervention3],[Intervention4],[Intervention5],[Intervention6],[Intervention7],[Intervention8],[Intervention9],[Intervention10],[Intervention11],[Intervention12],[Intervention13],[Intervention14],[Intervention15],[Intervention16],[Intervention17],[Intervention18],[Intervention19],[Intervention20],[Intervention21],[Intervention22],[Intervention23],[Intervention24],[Intervention25],[Intervention26],[Intervention27],[Intervention28],[Intervention29],[Intervention30],[Intervention31],[Intervention32],[Intervention33],[Intervention34],[Intervention35],[Intervention36],[Intervention37],[Intervention38],[Intervention39],[Intervention40],[Intervention41],[Intervention42],[Intervention43],[Intervention44],[Intervention45],[Intervention46],[Intervention47],[Intervention48],[Intervention49],[Intervention50],[Intervention51],[Intervention52],[Intervention53],[Intervention54],[Intervention55],[Intervention56],[Intervention57],[Intervention58],[Intervention59],[Intervention60],[Intervention61],[Intervention62],[Intervention63]
into #allInter
from (
       SELECT FIT.[AbstractID]
                ,'Intervention'+LTRIM(STR([InterventionInstance],4)) as [InterventionTitle]
                ,DI.[InterventionCode]
         FROM [TrilliumDataWarehouse].[dbo].[FactInpatientTemp] FIT
         inner join [TrilliumDataWarehouse].[dbo].[FactInpatientInterventionTemp] FIIT
         inner join [TrilliumDataWarehouse].[dbo].[DimIntervention] DI on DI.[InterventionKey]=FIIT.[InterventionKey]
         on FIIT.[AbstractID]=FIT.[AbstractID]
) as base
PIVOT
(
       max([InterventionCode])
       for [InterventionTitle] in ([Intervention1],[Intervention2],[Intervention3],[Intervention4],[Intervention5],[Intervention6],[Intervention7],[Intervention8],[Intervention9],[Intervention10],[Intervention11],[Intervention12],[Intervention13],[Intervention14],[Intervention15],[Intervention16],[Intervention17],[Intervention18],[Intervention19],[Intervention20],[Intervention21],[Intervention22],[Intervention23],[Intervention24],[Intervention25],[Intervention26],[Intervention27],[Intervention28],[Intervention29],[Intervention30],[Intervention31],[Intervention32],[Intervention33],[Intervention34],[Intervention35],[Intervention36],[Intervention37],[Intervention38],[Intervention39],[Intervention40],[Intervention41],[Intervention42],[Intervention43],[Intervention44],[Intervention45],[Intervention46],[Intervention47],[Intervention48],[Intervention49],[Intervention50],[Intervention51],[Intervention52],[Intervention53],[Intervention54],[Intervention55],[Intervention56],[Intervention57],[Intervention58],[Intervention59],[Intervention60],[Intervention61],[Intervention62],[Intervention63])
) as pvt


create index idx_allInter on #allInter([AbstractID])


-- ---------


IF OBJECT_ID('tempdb.dbo.#check', 'U') IS NOT NULL
       DROP TABLE #check;


SELECT dad.[AbstractID],dad.[SiteCode],dad.[EncounterNumber],dad.[ChartNumber],dad.[AdmitDate],dad.[DischargeDate]
,[Diagnosis1],[Diagnosis2],[Diagnosis3],[Diagnosis4],[Diagnosis5],[Diagnosis6],[Diagnosis7],[Diagnosis8],[Diagnosis9],[Diagnosis10],[Diagnosis11],[Diagnosis12],[Diagnosis13],[Diagnosis14],[Diagnosis15],[Diagnosis16],[Diagnosis17],[Diagnosis18],[Diagnosis19],[Diagnosis20],[Diagnosis21],[Diagnosis22],[Diagnosis23],[Diagnosis24],[Diagnosis25],[Diagnosis26],[Diagnosis27],[Diagnosis28],[Diagnosis29],[Diagnosis30],[Diagnosis31],[Diagnosis32],[Diagnosis33],[Diagnosis34],[Diagnosis35],[Diagnosis36],[Diagnosis37],[Diagnosis38],[Diagnosis39],[Diagnosis40],[Diagnosis41],[Diagnosis42],[Diagnosis43],[Diagnosis44],[Diagnosis45],[Diagnosis46],[Diagnosis47],[Diagnosis48],[Diagnosis49],[Diagnosis50],[Diagnosis51],[Diagnosis52],[Diagnosis53],[Diagnosis54],[Diagnosis55],[Diagnosis56],[Diagnosis57],[Diagnosis58],[Diagnosis59],[Diagnosis60],[Diagnosis61],[Diagnosis62],[Diagnosis63],[Diagnosis64],[Diagnosis65]
,[Intervention1],[Intervention2],[Intervention3],[Intervention4],[Intervention5],[Intervention6],[Intervention7],[Intervention8],[Intervention9],[Intervention10],[Intervention11],[Intervention12],[Intervention13],[Intervention14],[Intervention15],[Intervention16],[Intervention17],[Intervention18],[Intervention19],[Intervention20],[Intervention21],[Intervention22],[Intervention23],[Intervention24],[Intervention25],[Intervention26],[Intervention27],[Intervention28],[Intervention29],[Intervention30],[Intervention31],[Intervention32],[Intervention33],[Intervention34],[Intervention35],[Intervention36],[Intervention37],[Intervention38],[Intervention39],[Intervention40],[Intervention41],[Intervention42],[Intervention43],[Intervention44],[Intervention45],[Intervention46],[Intervention47],[Intervention48],[Intervention49],[Intervention50],[Intervention51],[Intervention52],[Intervention53],[Intervention54],[Intervention55],[Intervention56],[Intervention57],[Intervention58],[Intervention59],[Intervention60],[Intervention61],[Intervention62],[Intervention63]
      ,dad.[SiteDescription]
      ,dad.[PatientIdentifier]
      ,dad.[InstitutionCode]
      ,dad.[InstitutionDescription]
      ,dad.[HealthCareNumber]
      ,dad.[IsValidHealthCareNumber]
      ,dad.[HCNProvinceCode]
      ,dad.[HCNProvinceDescription]
      ,dad.[ResponsibilityForPaymentCode]
      ,dad.[ResponsibilityForPaymentDescription]
      ,dad.[RegisterNumber]
      ,dad.[BirthDate]
      ,dad.[AgeNumber]
      ,dad.[AgeCode]
      ,dad.[DischargeAge]
      ,dad.[DischargeAgeCode]
      ,dad.[GenderCode]
      ,dad.[GenderDescription]
      ,dad.[PostalCode]
      ,dad.[ResidenceCode]
      ,dad.[ResidenceCodeDescription]
      ,dad.[DateLeftER]
      ,dad.[DeliveryDate]
      ,dad.[WaitTimeER]
      ,dad.[EntryCode]
      ,dad.[EntryCodeDescription]
      ,dad.[AdmitCategoryCode]
      ,dad.[AdmitCategoryDescription]
      ,dad.[ReadmitCode]
      ,dad.[ReadmitDescription]
      ,dad.[DischargeDispositionCode]
      ,dad.[DischargeDispositionDescription]
      ,dad.[CMG_Year]
      ,dad.[MCC]
      ,dad.[MCCDescription]
      ,dad.[CMG]
      ,dad.[CMGDescription]
      ,dad.[CMG_RIW]
      ,dad.[CMG_ELOS]
      ,dad.[InpatientRIWAtypicalCode]
      ,dad.[InpatientRIWAtypicalCodeDescription]
      ,dad.[ComorbidityLevel]
      ,dad.[ComorbidityLevelDescription]
      ,dad.[CMGAgeCategory]
      ,dad.[CMGAgeCategoryDescription]
      ,dad.[InterventionEventCount]
      ,dad.[InterventionEventCountDescription]
      ,dad.[FlaggedIntervFactorCount]
      ,dad.[FlaggedInterventionEventCountDescription]
      ,dad.[InterventionOOHCount]
      ,dad.[InterventionOOHCountDescription]
      ,dad.[InpatientRILevel]
      ,dad.[HIGCode]
      ,dad.[HIGDescription]
      ,dad.[HIGWeight]
      ,dad.[HIGELOS]
      ,dad.[HIGFlTotalCount]
      ,dad.[LOSDays]
      ,dad.[AcuteLOS]
      ,dad.[ALCLOS]
      ,dad.[SCULOS]
      ,dad.[SCUHours]
      ,dad.[DischargeUnitKey]
      ,dad.[DischargeNursingUnitCode]
      ,dad.[DischargeNursingUnitDescription]
      ,dad.[InstitutionFromCode]
      ,dad.[InstitutionFromDescription]
      ,dad.[InstitutionFromCareType]
      ,dad.[InstitutionFromHospitalType]
      ,dad.[InstitutionToCode]
      ,dad.[InstitutionToDescription]
      ,dad.[InstitutionToCareType]
      ,dad.[InstitutionToHospitalType]
      ,dad.[DiagnosisType]
      ,dad.[DiagnosisTypeDescription]
      ,dad.[DiagnosisCode]
      ,dad.[DiagnosisCIHICode]
      ,dad.[DiagnosisDescription]
      ,dad.[DiagnosisCategoryCode]
      ,dad.[DiagnosisCategoryDescription]
      ,dad.[InterventionCode]
      ,dad.[InterventionCIHICode]
      ,dad.[InterventionDescription]
      ,dad.[InterventionCategoryCode]
      ,dad.[InterventionCategoryDescription]
      ,dad.[ProviderServiceCode]
      ,dad.[ProviderServiceDescription]
      ,dad.[ProviderTypeCode]
      ,dad.[ProviderTypeDescription]
      ,dad.[ProviderCode]
      ,dad.[ProviderName]
      ,dad.[ProviderCodeMeditech]
      ,dad.[PatientServiceCode]
      ,dad.[PatientServiceDescription]
      ,dad.[FI_CardioversionFlag]
      ,dad.[FI_CellSaverFlag]
      ,dad.[FI_ChemotherapyFlag]
      ,dad.[FI_DialysisFlag]
      ,dad.[FI_HeartResuscitationFlag]
      ,dad.[FI_MechanicalVentGreat96Hours]
      ,dad.[FI_MechanicalVentLess96Hours]
      ,dad.[FI_FeedingTubeFlag]
      ,dad.[FI_ParacentesisFlag]
      ,dad.[FI_ParenteralNutritionFlag]
      ,dad.[FI_PleurocentesisFlag]
      ,dad.[FI_RadiotherapyFlag]
      ,dad.[FI_TracheostomyFlag]
      ,dad.[FI_VascularAccessDdeviceFlag]
      ,dad.[DxIntervPartition]
      ,dad.[DxIntervPartitionDesc]
      ,dad.[AgeGroupKey]
      ,dad.[FSA]
      ,dad.[LHIN]
      ,dad.[AgeDays]
      ,dad.[AgeMonths]
      ,dad.[AgeYears]
      ,dad.[ResidenceRegion]
      ,dad.[IntervLocation]
      ,dad.[IntervLocationDesc]
      ,dad.[InterventionProviderNumber]
      ,dad.[InterventionProviderNumberDesc]
      ,dad.[InterventionProviderService]
      ,dad.[IntervProviderServiceDesc]
      ,dad.[CodedAgeGroup]
      ,dad.[GestationalAgeinweeks]
      ,dad.[LOSTimeinHours]
      ,dad.[OffService]
      ,dad.[IntervBodyLocation]
      ,dad.[IntervBodyLocationDesc]
      ,dad.[SCUNumber]
      ,dad.[InterventionAttributeStatus]
      ,dad.[InterventionAttributeStatusDescription]
      ,dad.[AnaestheticTechniqueCode]
      ,dad.[AnaestheticTechniqueDescription]
      ,dad.[HIGTypicalAtypicalCode]
      ,dad.[HIGTypicalAtypicalDescription]
      ,dad.[InternalProgramMapping]
        ,u.DisplayCode
        ,u.DefaultDescription
      ,qbp.[QBPNeonatalJaundice]
      ,qbp.[COPD]
      ,qbp.[Pneumonia]
      ,qbp.[Tonsillectomy]
      ,qbp.[CHF]
      ,qbp.[HipFracture]
      ,qbp.[Stroke_Hemorrhage]
      ,qbp.[Stroke_Ischemic]
      ,qbp.[Stroke_Unspecified]
      ,qbp.[Stroke_TIA]
      ,qbp.[Non_cardiac_Vascular_LEOD]
      ,qbp.[Non_cardiac_Vascular_AA]
      ,qbp.[Non_cardiac_Vascular_EVAR]
      ,qbp.[Non_cardiac_Vascular_EVAR_ADV]
      ,qbp.[Non_cardiac_Vascular_EVAR_MOD]
      ,qbp.[Non_cardiac_Vascular_EVAR_STD]
      ,qbp.[Non_cardiac_Vascular_OPEN]
      ,qbp.[UnilateralHipReplacement]
      ,qbp.[UnilateralKneeReplacement]
      ,qbp.[BilateralHipKneeReplacement]
      ,qbp.[CancerSurgeryRadicalProstatectomy]
      ,qbp.[CancerSurgeryColonAndRectalResection]
      ,qbp.[Endo]
      ,qbp.[EndoSpecialized]
      ,qbp.[EndoQBPIndexProc]
      ,qbp.[EndoQBPWeight]
      ,qbp.[Retinal]
      ,qbp.[KneeArthroscopy]
      ,qbp.[Thyroid]
      ,qbp.[GeneralBreastImmediateRecon]
      ,qbp.[GeneralBreastWithoutImmediateRecon]
      ,qbp.[BreastALND]
      ,qbp.[BreastDelayedReconstruction]
      ,qbp.[BreastProphylacticWithRecon]
      ,qbp.[BreastProphylacticWithoutRecon]
      ,qbp.[BreastSLNB]
into #check
FROM #DAD dad inner join [SRV-WINRECS02\REPORTS].Med2020Reports.dbo.AB_Abstract a on dad.AbstractID  = a.AbstractID
        left join [SRV-WINRECS02\REPORTS].Med2020Reports.dbo.U_Users u with (nolock) on a.CoderNumber = u.Code
        left join #allDiag d on d.AbstractID  = dad.AbstractID
        left join #allInter i on d.[AbstractID]=i.[AbstractID]
        left join [dbo].[vFilterSets] qbp on qbp.AbstractID = dad.AbstractID
--        left join [SRV-WINRECS02\REPORTS].Med2020Reports.dbo.AB_Abstract a on d.AbstractID  = a.AbstractID


     -- left outer join #DAD dad on i.[AbstractID]=dad.[AbstractID]
    where dad.[CMG_Year] = '2016'


select * from #check -- where [COPD]+[Pneumonia] <> 'N/AN/A'
--where [Diagnosis1] is null or [Intervention1] is null
--drop table #check


set nocount off;
